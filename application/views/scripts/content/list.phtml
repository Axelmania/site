<?php 
    // add stylesheet
    $this->headLink()->appendStylesheet($this->baseUrl('/css/style_additions_req.css'));  

    // change background color
    $color = array( 'problem' => '#d21034',
    				'idea' => '#4b9b07',
    				'finfo' => '#ffc726');
    
    if (isset($color[$this->type])) {
	    $this->headScript()->captureStart(); 
	    ?> changeBack('<?php echo $color[$this->type]; ?>'); <?php
	    $this->headScript()->captureEnd(); 
    }
            
    // some variable initiation
    $url_tag_cloud = $this->url(array('controller' => 'tag',
        'action' => 'index',
        'language' => $this->language), 
        'lang_default', true);
        
    $url_sign_up = $this->url(array('controller' => 'account',
        'action' => 'register',
        'language' => $this->language), 
        'lang_default', true);
    
	$url_getRecentContent = $this->url(array('controller' => 'ajax',
											 'action' => 'getrecentcontent',
											 'type' => $this->type,
											 'language' => $this->language), 
											 'lang_default', true);
	
	$url_checkRecentContent = $this->url(array('controller' => 'ajax',
											   'action' => 'checkrecentcontent',
											   'language' => $this->language), 
											   'lang_default', true);
?>

<?php $this->headScript()->captureStart()?>

$(document).ready(function(){
	recentpostsdiv  = '#content_list_ajax';
	recentpostslink = '#content_list_ajax_link';
	recentpostslink_orig = $(recentpostslink).html();
	pagecount = 1;
	previousresult = "";

	$(recentpostslink+' a').live('click', function(){
		pagecount = pagecount + 1;
		ajaxLoad_getRecentPosts(recentpostsdiv, pagecount);
	});

	ajaxLoad_checkRecentPosts();
	//ajaxLoad_getRecentPosts(recentpostsdiv, pagecount);
	
});

	function ajaxLoad_getRecentPosts(obj, offset, prepend){
		$.ajax({
			beforeSend: function(){
				$(recentpostslink).html(
					'<h3 style="vertical-align: middle;"><img src="<?php echo $this->baseUrl('/images/ajax-loader-black.gif');?>" style="padding-right: 10px;" /> ' + 
					'Please wait...</h3>'
				);
			},
			complete: function(){
				$(recentpostslink).html(recentpostslink_orig);
			},
			url: "<?php echo $url_getRecentContent; ?>/offset/"+offset,
			success: function(result){
				if(prepend == 1) {
					$(obj).prepend(result);
				} else {
					$(obj).append(result);
				}
				$('.user_content_row_new').hide();
				removeDupes_recentPosts(recentpostsdiv);
				$('.user_content_row_new').removeClass('user_content_row_new');
				$('.user_content_row').fadeIn('slow');
			}
		});
	};
	
	function removeDupes_recentPosts(obj){
		$(recentpostsdiv + ' [id]').each(function(){
			var ids = $('[id='+this.id+']');
			if(ids.length > 1 && ids[0]!=this){
				console.warn('Multiple IDs #'+this.id);
				$(this).remove();
			}
		});
	}

	function ajaxLoad_checkRecentPosts(){
		$.ajax({
			url: "<?php echo $url_checkRecentContent; ?>/check/",
			success: function(result){
				//alert(result + " | " + previousresult);
				if(result != previousresult) {
					ajaxLoad_getRecentPosts(recentpostsdiv, 1, 1);
				}
				previousresult = result;
				setTimeout("ajaxLoad_checkRecentPosts()", 30000);
			}
		});
	}

<?php $this->headScript()->captureEnd()?>

<div class="content_list_recent">
	<h3 class="recent_posts"><?php echo $this->translate('content-list-'.$this->type); ?>
		<a href="<?php echo $this->url(array('controller' => 'rss',
                                             'action' => 'generate',
											 'type' => $this->type,
                                             'language' => $this->language),
                                           	 'lang_default', true); ?>">
			<img class="rsslogo" src="<?php echo $this->baseUrl('/images/icon_rss_28x28.png'); ?>" alt="RSS" width="18" height="18" />
		</a>
        <a href="<?php echo $this->url(array('controller' => 'voice',
                                             'action' => 'generate',
        									 'type' => $this->type,
                                             'language' => $this->language),
                                             'lang_default', true); ?>">
			<img class="rsslogo" src="<?php echo $this->baseUrl('/images/podcasts.png'); ?>" alt="RSS" width="18" height="18" />
		</a>
	</h3>
	<div class="user_content_list" style="padding: 0px; margin: 0px; overflow:hidden;">
		<div id="content_list_ajax" style="width: 500px;"></div>
	    <div class="user_content_spacer">
	        <img src="<?php echo $this->baseUrl('/images/gray_dot_line_500.png'); ?>" alt="Massidea.org" />
	    </div>
	    
	    <div id="content_list_ajax_link" style="margin-top: 10px; margin-left: 220px;">
	        <h3>
	            <a href="#" onclick="return false;"><?php echo $this->translate('index-view-more'); ?></a>
	        </h3>
	    </div>
	</div>
    
    <div class="right_side" style="padding: 0px; margin: 0px; margin-top: 0px;">
        <p class="right_side_title_small" style="padding-top: 0px; padding-bottom:3px;">
            <?php echo $this->translate('content-list-right-header-'.$this->type); ?>
        </p>
        
        <div class="top_right_box">
            <div>
                <p><?php echo $this->translate('content-list-right-p1-'.$this->type); ?></p>
                <p><?php echo $this->translate('content-list-right-p2-'.$this->type); ?></p>
                <p><?php echo $this->translate('content-list-right-p3'); ?></p>
            </div>
        </div>
        
        <p id="tags_link" style="margin-top: 1px;" class="top_right_box_links">
            <?php echo $this->translate('index-most-popular')?>
            <a href="<?php echo $url_tag_cloud; ?>">
                <?php echo $this->translate('index-tags')?>
            </a>
        </p>
        
		<img src="<?php echo $this->baseUrl('/images/gray_dot_line_200.png'); ?>" alt="Massidea.org" />
        
        <div class="tag_cloud">
            <?php if (isset($this->tags)): ?>
            
                <?php foreach ($this->tags as $tag): ?>
                
                    <a href="<?php echo $this->url(array('controller' => 'tag',
                                            'action' => 'view',
                                            'id' => $tag['id_tag'],
                                            'language' => $this->language),
                                      'lang_default', true); ?>" style="font-size:<?php echo $tag['tag_size']; ?>%">
                        <?php echo stripslashes($tag['name_tag']); ?>
                    </a>
                    
                <?php endforeach; ?>
                
            <?php endif; ?>
            <p id="show_all_tags" style="padding: 0px;" class="top_right_box_links">
                <a href="<?php echo $this->url(array('controller' => 'tag',
                                                     'action' => 'index',
                                                     'language' => $this->language), 
                                                	 'lang_default', true); ?>">
                    <?php echo $this->translate('index-show-all')?>
                </a>
            </p>
		</div>
        
        <img src="<?php echo $this->baseUrl('/images/gray_dot_line_200.png'); ?>" alt="Massidea.org" />
        
        <h3 style="padding:0; margin-top: 5px;">
            <?php echo $this->translate('content-list-missing-header'); ?>
        </h3>
        
        <p style="padding:0; margin:0;">
            <?php echo $this->translate('index-opensource'); ?>
        </p>
        
    </div>
</div>